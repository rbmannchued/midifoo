#include "display_service.h"
#include "i2c_hal.h"
#include "ssd1306.h"
#include "ssd1306_fonts.h"
#include <math.h>
#include <stdio.h>


//bitmaps for battery icon 20x12
const unsigned char epd_bitmap_batt_100 []  = {
	0xff, 0xff, 0xe0, 0x80, 0x00, 0x20, 0xbb, 0xbb, 0xa0, 0xbb, 0xbb, 0xb0, 0xbb, 0xbb, 0xb0, 0xbb, 
	0xbb, 0xb0, 0xbb, 0xbb, 0xb0, 0xbb, 0xbb, 0xb0, 0xbb, 0xbb, 0xb0, 0xbb, 0xbb, 0xa0, 0x80, 0x00, 
	0x20, 0xff, 0xff, 0xe0
};

const unsigned char epd_bitmap_batt_75 [] = {
	0xff, 0xff, 0xe0, 0x80, 0x00, 0x20, 0xbb, 0xb8, 0x20, 0xbb, 0xb8, 0x30, 0xbb, 0xb8, 0x30, 0xbb, 
	0xb8, 0x30, 0xbb, 0xb8, 0x30, 0xbb, 0xb8, 0x30, 0xbb, 0xb8, 0x30, 0xbb, 0xb8, 0x20, 0x80, 0x00, 
	0x20, 0xff, 0xff, 0xe0
};

const unsigned char epd_bitmap_batt_50 [] = {
	0xff, 0xff, 0xe0, 0x80, 0x00, 0x20, 0xbb, 0x80, 0x20, 0xbb, 0x80, 0x30, 0xbb, 0x80, 0x30, 0xbb, 
	0x80, 0x30, 0xbb, 0x80, 0x30, 0xbb, 0x80, 0x30, 0xbb, 0x80, 0x30, 0xbb, 0x80, 0x20, 0x80, 0x00, 
	0x20, 0xff, 0xff, 0xe0
};

const unsigned char epd_bitmap_batt_25 [] = {
	0xff, 0xff, 0xe0, 0x80, 0x00, 0x20, 0xb8, 0x00, 0x20, 0xb8, 0x00, 0x30, 0xb8, 0x00, 0x30, 0xb8, 
	0x00, 0x30, 0xb8, 0x00, 0x30, 0xb8, 0x00, 0x30, 0xb8, 0x00, 0x30, 0xb8, 0x00, 0x20, 0x80, 0x00, 
	0x20, 0xff, 0xff, 0xe0
};

const unsigned char epd_bitmap_batt_0 [] = {
	0xff, 0xff, 0xe0, 0x80, 0x00, 0x20, 0x80, 0x00, 0x20, 0x80, 0x00, 0x30, 0x80, 0x00, 0x30, 0x80, 
	0x00, 0x30, 0x80, 0x00, 0x30, 0x80, 0x00, 0x30, 0x80, 0x00, 0x30, 0x80, 0x00, 0x20, 0x80, 0x00, 
	0x20, 0xff, 0xff, 0xe0
};

// 'midifoo-logo', 128x64px
const unsigned char epd_bitmap_midifoo_face [] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xfc, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xfe, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x70, 0x00, 0x1f, 0xff, 0xff, 0x80, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x04, 0x0c, 0x07, 0x07, 0xc0, 0x78, 0x00, 0x3f, 0xf7, 0xff, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x06, 0x0c, 0x07, 0x8f, 0xe0, 0x38, 0x00, 0x3f, 0xc7, 0xe7, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0x0c, 0x03, 0x8f, 0xf0, 0x00, 0x00, 0x7c, 0x07, 0xe7, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0x1c, 0x00, 0x0e, 0x78, 0x00, 0x00, 0x7c, 0x1f, 0xe3, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0x1c, 0x00, 0x0e, 0x3c, 0x78, 0x00, 0x7f, 0xff, 0xf0, 0x20, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0x1e, 0x07, 0x8e, 0x1c, 0x78, 0x00, 0x7f, 0xff, 0xfc, 0x20, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x1f, 0xbe, 0x07, 0x8e, 0x1c, 0x78, 0x00, 0x7f, 0xf3, 0xff, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x1f, 0xbe, 0x07, 0x8e, 0x1c, 0x78, 0x00, 0x7f, 0xf3, 0xdf, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x1d, 0xfe, 0x07, 0x8e, 0x1c, 0x78, 0x00, 0x7f, 0xf3, 0xcf, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x39, 0xe7, 0x07, 0x8e, 0x1c, 0x78, 0x00, 0x7f, 0xe7, 0xcf, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x71, 0xe7, 0x07, 0x8e, 0x1c, 0x78, 0x00, 0x7f, 0xc7, 0xc7, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xf1, 0xe7, 0x07, 0x8e, 0x3c, 0x78, 0x00, 0x3f, 0xcf, 0xe7, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe1, 0xe3, 0x87, 0x0e, 0x78, 0x70, 0x00, 0x3f, 0xc0, 0x07, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xe0, 0xe3, 0xc7, 0x0f, 0xf0, 0x70, 0x00, 0x1f, 0xe0, 0x0f, 0x80, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc7, 0x07, 0xe0, 0x70, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x07, 0xe0, 0x1e, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf0, 0x1c, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0xc0, 0x1f, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xfc, 0x7f, 0x03, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x7f, 0x83, 0xfe, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x79, 0xc3, 0xce, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x70, 0xc3, 0x86, 0x00, 0x00, 0x40, 0x03, 0x80, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x70, 0xc3, 0x86, 0x00, 0x00, 0x40, 0x02, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x70, 0xc3, 0x86, 0x00, 0x00, 0xe0, 0x02, 0x40, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x70, 0xc3, 0x86, 0x00, 0x00, 0xe0, 0x06, 0x60, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x70, 0xc3, 0x86, 0x00, 0x00, 0xb0, 0x06, 0x70, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x70, 0xc3, 0x86, 0x00, 0x01, 0xb0, 0x06, 0x3f, 0x80, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x70, 0xc3, 0x86, 0x01, 0xe3, 0x98, 0x0c, 0x3f, 0x80, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x79, 0xc3, 0xce, 0x03, 0xff, 0x18, 0xfc, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x7f, 0xc3, 0xfe, 0x00, 0x3e, 0x09, 0xfc, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x7f, 0xc3, 0xfe, 0x00, 0x00, 0x0d, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x3f, 0x81, 0xfc, 0x00, 0x00, 0x05, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};



void display_service_init(){
    i2c_hal_init();
    ssd1306_Init();
    
    //fix led bugs on display
    ssd1306_Line(130, 1, 130, 64, Black);
    ssd1306_Line(129, 1, 129, 64, Black);
    
    ssd1306_UpdateScreen();
}

void display_service_showNoteBank(int8_t offset) {
    char buf[8];
    snprintf(buf, sizeof(buf), "A%d", offset);
    ssd1306_FillRectangle(10, 40, 90, 11, Black); // clean the region first
    ssd1306_SetCursor(50, 20);
    ssd1306_WriteString(buf, Font_16x26, White);
    ssd1306_UpdateScreen();
}

void display_service_showTunerInfo(int noteDiff, const char *noteName, int octave) {
    ssd1306_Fill(Black);

    char buf[8];
    snprintf(buf, sizeof(buf), "%s%d", noteName, octave);
    ssd1306_SetCursor(8, 10);
    ssd1306_WriteString(buf, Font_16x26, White);

    snprintf(buf, sizeof(buf), "%+dÂ¢", noteDiff);
    ssd1306_SetCursor(90, 10);
    ssd1306_WriteString(buf, Font_11x18, White);

    const int centerX = 64;
    const int barTop = 50;
    const int barBottom = 63;
    ssd1306_Line(centerX, barTop, centerX, barBottom, White);

    int pointerOffset = (int)(noteDiff * 0.8f);
    if (pointerOffset > 40) pointerOffset = 40;
    if (pointerOffset < -40) pointerOffset = -40;
    int pointerX = centerX + pointerOffset;

    ssd1306_Line(pointerX, barBottom, pointerX, barTop - 5, White);

    ssd1306_Line(centerX - 40, barTop, centerX - 40, barBottom, White);
    ssd1306_Line(centerX + 40, barTop, centerX + 40, barBottom, White);

    ssd1306_UpdateScreen();
}

void display_service_showNoSignal(void) {
    ssd1306_Fill(Black);
    ssd1306_SetCursor(8, 10);
    ssd1306_WriteString("...", Font_16x26, White);
    ssd1306_UpdateScreen();
}
void display_service_showBatteryIcon(uint8_t level) {
    ssd1306_FillRectangle(108, 0, 127, 11, Black); // clean the region first
    switch(level) {



    case 25:
        ssd1306_DrawBitmap(128-20, 0, epd_bitmap_batt_25, 20, 12, White);
        break;

    case 50:
        ssd1306_DrawBitmap(128-20, 0, epd_bitmap_batt_50, 20, 12, White);
        break;

    case 75:
        ssd1306_DrawBitmap(128-20, 0, epd_bitmap_batt_75, 20, 12, White);
        break;

    case 100:
        ssd1306_DrawBitmap(128-20, 0, epd_bitmap_batt_100, 20, 12, White);
        break;

    default:
        ssd1306_DrawBitmap(128-20, 0, epd_bitmap_batt_0, 20, 12, White);
        break;
    }

    ssd1306_UpdateScreen();
}

void display_service_showLogo(){
    display_service_eraseScreen();
    ssd1306_DrawBitmap(0, 0, epd_bitmap_midifoo_face, 128, 64, White);
    ssd1306_UpdateScreen();

    for (int i = 0; i < 80000000; i++) { __asm__("nop"); }
    display_service_eraseScreen();
}

void display_service_eraseScreen(){
    ssd1306_Fill(Black);
}
